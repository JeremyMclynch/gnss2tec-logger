name: Build DEB Packages

on:
  workflow_dispatch:
  push:
    branches:
      - main
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-debs:
    runs-on: ubuntu-latest
    container:
      image: debian:bullseye

    env:
      DEBIAN_FRONTEND: noninteractive

    steps:
      - name: Install system dependencies
        run: |
          dpkg --add-architecture arm64
          apt-get update
          apt-get install -y --no-install-recommends \
            ca-certificates \
            curl \
            git \
            build-essential \
            dpkg-dev \
            pkg-config \
            libudev-dev \
            libudev-dev:arm64 \
            gcc-aarch64-linux-gnu \
            libc6-dev-arm64-cross

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        run: |
          curl https://sh.rustup.rs -sSf | sh -s -- -y --profile minimal --default-toolchain stable
          echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
          . "$HOME/.cargo/env"
          rustup target add aarch64-unknown-linux-gnu
          rustc --version
          cargo --version

      - name: Ensure packaging script is executable
        run: chmod +x scripts/build-deb.sh

      - name: Build amd64 package
        run: ./scripts/build-deb.sh --deb-arch amd64

      - name: Build arm64 package
        env:
          PKG_CONFIG_ALLOW_CROSS: "1"
          PKG_CONFIG_LIBDIR: /usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig
          PKG_CONFIG_PATH: /usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig
        run: ./scripts/build-deb.sh --target aarch64-unknown-linux-gnu --deb-arch arm64

      - name: Show built packages
        run: ls -lh dist/*.deb

      - name: Upload workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gnss2tec-debs-${{ github.sha }}
          path: dist/*.deb
          if-no-files-found: error

      - name: Publish release assets
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.deb
          generate_release_notes: true
